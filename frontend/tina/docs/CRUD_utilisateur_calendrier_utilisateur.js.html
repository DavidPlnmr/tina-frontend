<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: CRUD_utilisateur/calendrier_utilisateur.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: CRUD_utilisateur/calendrier_utilisateur.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { useState, useRef, useEffect } from "react";
import { Calendar } from "@fullcalendar/core";
import listPlugin from "@fullcalendar/list";
import Header from "../header";
import axios from "axios";
import { addMinutes } from "date-fns";
import { parseCookies } from "nookies";
import { useRouter } from "next/router";
import Footer from "../footer";

/**
 * @namespace 'calendrier_utilisateur.js'
 * @description This component provides the functionality to create and manage a user's calendar.
 * @returns {JSX.Element} A React functional component rendering the calendar interface.
 */

export default function CalendrierClient() {
  /**
   * @constant calendar
   * @memberof 'calendrier_utilisateur.js'
   * @description This stateful constant stores the calendar object.
   * @default null
   * @type {useState}
   */
  const [calendar, setCalendar] = useState(null);

  /**
   * @constant calendarEl
   * @memberof 'calendrier_utilisateur.js'
   * @description This constant contains a reference to the calendar HTML element.
   * @default null
   * @type {object}
   */
  const calendarEl = useRef(null);

  /**
   * @constant events
   * @memberof 'calendrier_utilisateur.js'
   * @description This stateful constant holds the array of events in the calendar.
   * @default []
   * @type {useState}
   */
  const [events, setEvents] = useState([]);

  /**
   * @constant event
   * @memberof 'calendrier_utilisateur.js'
   * @description This constant is an useRef used to determine we already passed in the useEffect.
   * @default false
   * @type {object}
   * @property {boolean} current - The current value of the ref.
   */
  const event = useRef(false);

  /**
   * @constant cookies
   * @memberof 'calendrier_utilisateur.js'
   * @see {@link 'header.js'.cookies}
   */
  const cookies = parseCookies();

  /**
   * @constant router
   * @memberof 'calendrier_utilisateur.js'
   * @see {@link 'header.js'.router}
   */
  const router = useRouter();

  /**
   * @var customer
   * @memberof 'calendrier_utilisateur.js'
   * @description This variable stores the customer's information.
   * @default null
   * @type {object}
   */
  let customer = null;

  /**
   * @var information
   * @memberof 'calendrier_utilisateur.js'
   * @description This variable stores the appointment's information.
   * @default null
   * @type {object}
   */
  let information = null;

   /**
   * @function handleClick
   * @memberof 'calendrier_utilisateur.js'
   * @description This function redirects the user to the appointment details page, passing the id of the appointment as a parameter.
   * @param {number} id - The ID of the appointment.
   * @returns {void}
   */
  const handleClick = (id) => {
    router.push({
      pathname: "/components/CRUD_utilisateur/CRUD_my_rdv/detail_rdv",
      query: { id: id },
    });
  };

  /**
   * @function useEffect1
   * @memberof 'calendrier_utilisateur.js'
   * @description This effect performs API calls to fetch user appointments and specific appointment data. It's run once when the component mounts.
   * @returns {void}
   * @async
   */
  useEffect(() => {
    const fetchAppointments = async () => {
      try {
        const response = await axios.get(
          "http://127.0.0.1:8000/api/my-appointments/",
          {
            headers: {
              Authorization: "Token " + cookies.csrftoken,
            },
          }
        );
        const appointments = response.data;
        console.log(appointments);

        if (appointments.length > 0) {
          const newEvents = await Promise.all(
            appointments
              .filter((a) => {
                return a.status === "pending" || a.status === "confirmed";
              })
              .map(async (appointment) => {
                // Fetch service info for each appointment
                const response2 = await axios.get(
                  "http://127.0.0.1:8000/api/services/" +
                    appointment.service +
                    "/",
                  {
                    headers: {
                      Authorization: "Token " + cookies.csrftoken,
                    },
                  }
                );
                const service = response2.data;

                const response3 = await axios.get(
                  "http://127.0.0.1:8000/api/employees/" +
                    appointment.employee +
                    "/",
                  {
                    headers: {
                      Authorization: "Token " + cookies.csrftoken,
                    },
                  }
                );
                console.log(appointment.customer);
                let response4 = null;
                if (appointment.customer != null) {
                  response4 = await axios.get(
                    "http://127.0.0.1:8000/api/customers/" +
                      appointment.customer +
                      "/",
                    {
                      headers: {
                        Authorization: "Token " + cookies.csrftoken,
                      },
                    }
                  );
                  customer = response4.data;
                } else {
                  response4 = appointment.informations;
                  information = response4;
                }

                const employee = response3.data;
                let myTitle = "";
                const start = new Date(
                  `${appointment.date}T${appointment.time}`
                );
                const end = addMinutes(start, service.duration.slice(3, 5));
                if (cookies.role === "customer") {
                  myTitle = `Service : ${service.name} avec ${employee.first_name} ${employee.last_name} / (cliquez pour gérer le rendez-vous)`;
                } else if (cookies.role === "employee") {
                  if (appointment.customer != null) {
                    myTitle = `Service : ${service.name} / avec le client ${customer.first_name} ${customer.last_name} (cliquez pour gérer le rendez-vous)`;
                  } else {
                    myTitle = `Service : ${service.name} / informations : ${information} (cliquez pour gérer le rendez-vous)`;
                  }
                }

                // Create event object with service info
                return {
                  id: appointment.id,
                  title: myTitle,
                  start: start.toISOString(),
                  end: end.toISOString(),
                  allDay: false,
                  service: service, // add service info to event object
                };
              })
          );
          setEvents(newEvents);
        }
      } catch (error) {
        console.error(error);
      }
    };

    fetchAppointments();
  }, []);

  /**
   * @function useEffect2
   * @memberof 'calendrier_utilisateur.js'
   * @description This effect is responsible for sending events to the calendar and calling the handleClick function. It runs when the events state changes.
   * @returns {void}
   * @async
   */

  useEffect(() => {
    if (calendar !== null &amp;&amp; events.length > 0) {
      if (event.current) return;
      event.current = true;
      calendar.addEventSource(events);
      // Ajouter la classe 'event-passe' aux événements passés
      const maintenant = new Date();
      const eventsPasse = calendar
        .getEvents()
        .filter((event) => event.start &lt; maintenant);
      eventsPasse.forEach((event) => {
        event.setProp("classNames", ["event-passe"]);
      });

      calendar.setOption("eventClick", (info) => {
        handleClick(info.event.id);
      });
    }
  }, [events]);

  /**
   * @function useEffect3
   * @memberof 'calendrier_utilisateur.js'
   * @description This effect sets up the calendar and displays the events. It's run once when the component mounts.
   * @returns {void}
   * @async
   */
  useEffect(() => {
    if (calendarEl.current !== null) {
      const newCalendar = new Calendar(calendarEl.current, {
        initialView: "listWeek",
        firstDay: 1,
        height: "auto",
        allDaySlot: false,
        slotDuration: "00:15:00",
        slotEventOverlap: false,
        slotMinTime: "09:00:00",
        slotMaxTime: "19:00:00",
        headerToolbar: {
          start: "prev,next today",
          center: "title",
          end: "listWeek",
        },
        views: {
          timeGridWeek: {
            type: "timeGrid",
            duration: { weeks: 1 },
            buttonText: "Semaine",
            contentHeight: 500,
            slotLabelFormat: {
              hour: "numeric",
              minute: "2-digit",
              omitZeroMinute: false,
              meridiem: "narrow",
            },
          },
        },
        plugins: [listPlugin],
        locale: "fr", // définit la langue du calendrier en français
        buttonText: {
          today: "aujourd'hui",
        },
        eventContent: function (info) {
          const available = info.event.extendedProps.available;
          const backgroundColor = available ? "#2A4494" : "#2A4494"; // Détermine la couleur de fond en fonction de la disponibilité
          const title = info.event.title.split(" / ");
          const textColor = available ? "white" : "black"; // Détermine la couleur du texte en fonction de la disponibilité
          return {
            html: `&lt;div style="text-align: center; background-color: ${backgroundColor}; color: white; font-size:12px;">&lt;div >${title[0]}&lt;/div>&lt;div >${title[1]}&lt;/div>&lt;/b>&lt;/div>`,
          };
        },
      });

      setCalendar(newCalendar);
      newCalendar.render();

      return () => {
        newCalendar.destroy();
      };
    }
  }, [calendarEl]);

  return (
    &lt;>
      &lt;style>
        {`@media (max-width: 600px) {
        .fc-today-button {
          display: none;
        }
      }`}
      &lt;/style>
      &lt;Header />
      &lt;div className="container">
        &lt;div
          ref={calendarEl}
          className="mx-auto"
          style={{ marginTop: "5%", marginBottom: "510px" }}
        >&lt;/div>
      &lt;/div>
      &lt;Footer />
    &lt;/>
  );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="-_calendrier.js_.html">'calendrier.js'</a></li><li><a href="-_calendrier_utilisateur.js_.html">'calendrier_utilisateur.js'</a></li><li><a href="-_choix_client.js_.html">'choix_client.js'</a></li><li><a href="-_confirmation_rdv.js_.html">'confirmation_rdv.js'</a></li><li><a href="-_connexion.js_.html">'connexion.js'</a></li><li><a href="-_header.js_.html">'header.js'</a></li><li><a href="-_inscription.js_.html">'inscription.js'</a></li><li><a href="-_no_client_rdv.js_.html">'no_client_rdv.js'</a></li><li><a href="-_profil_utilisateur.js_.html">'profil_utilisateur.js'</a></li><li><a href="-_recap_rdv.js_.html">'recap_rdv.js'</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Wed May 17 2023 14:19:15 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
